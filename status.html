<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Chat App</title>
    <link rel="stylesheet" href="chat.css">
</head>
<body>
    <!-- Auth Modal -->
    <div class="auth-container" id="auth-modal">
        <div class="auth-modal">
            <h2>ƒêƒÉng nh·∫≠p ƒë·ªÉ b·∫Øt ƒë·∫ßu</h2>
            <div class="auth-tabs">
                <button class="auth-tab active" id="login-tab" onclick="switchAuthMode('login')">ƒêƒÉng nh·∫≠p</button>
                <button class="auth-tab" id="register-tab" onclick="switchAuthMode('register')">ƒêƒÉng k√Ω</button>
            </div>
            <div class="auth-form">
                <input 
                    type="text" 
                    id="auth-username" 
                    placeholder="T√™n ng∆∞·ªùi d√πng"
                    maxlength="20"
                >
                <input 
                    type="password" 
                    id="auth-password" 
                    placeholder="M·∫≠t kh·∫©u"
                    maxlength="40"
                >
                <button id="auth-submit" onclick="handleAuthSubmit()">Ti·∫øp t·ª•c</button>
                <p class="auth-hint">M·∫≠t kh·∫©u t·ªëi thi·ªÉu 6 k√Ω t·ª±</p>
            </div>
        </div>
    </div>

    <!-- Room Selection Modal -->
    <div class="room-selection-container hidden" id="room-modal">
        <div class="room-modal">
            <h2>Ch·ªçn ph√≤ng chat</h2>
            <div class="room-list" id="room-list"></div>
            <div class="create-room">
                <input 
                    type="text" 
                    id="new-room-name" 
                    placeholder="T√™n ph√≤ng m·ªõi (vd: music)"
                    maxlength="30"
                >
                <button onclick="createRoom()">T·∫°o ph√≤ng</button>
            </div>
        </div>
    </div>

    <!-- Chat Container -->
    <div class="chat-container hidden" id="chat-container">
        <div class="chat-header">
            <h1>
                üí¨ Chat App
                <span class="status-indicator" id="connection-indicator"></span>
            </h1>
            <div class="user-info">
                <span id="username-display"></span>
                <span class="current-room" id="room-display"></span>
                <span class="user-count">
                    (<span id="user-count">0</span> ng∆∞·ªùi trong ph√≤ng)
                </span>
            </div>
        </div>

        <div class="chat-messages" id="messages-container"></div>

        <div class="chat-input-container">
            <div class="input-group">
                <input 
                    type="text" 
                    id="message-input" 
                    placeholder="Nh·∫≠p tin nh·∫Øn..."
                    maxlength="500"
                >
                <button id="send-button" onclick="sendMessage()">G·ª≠i</button>
            </div>
        </div>
    </div>

    <!-- Container cho hi·ªáu ·ª©ng particles -->
    <div class="particles-container" id="particles-container"></div>

    <script>
        // ===== BI·∫æN L∆ØU TH√îNG TIN =====
        let socket = null;          // K·∫øt n·ªëi WebSocket
        let username = '';          // T√™n ng∆∞·ªùi d√πng
        let authToken = '';         // Token ƒëƒÉng nh·∫≠p
        let currentRoom = '';       // Ph√≤ng hi·ªán t·∫°i
        let userCount = 0;          // S·ªë ng∆∞·ªùi ƒëang online trong ph√≤ng
        let clientId = '';          // ID c·ªßa m√¨nh
        let authMode = 'login';     // login | register
        let rooms = [];             // Danh s√°ch ph√≤ng
        let isAuthLoading = false;  // Tr·∫°ng th√°i submit form auth

        // ===== L·∫§Y C√ÅC PH·∫¶N T·ª¨ TR√äN TRANG =====
        const authModal = document.getElementById('auth-modal');
        const roomModal = document.getElementById('room-modal');
        const authUsernameInput = document.getElementById('auth-username');
        const authPasswordInput = document.getElementById('auth-password');
        const authSubmitButton = document.getElementById('auth-submit');
        const loginTab = document.getElementById('login-tab');
        const registerTab = document.getElementById('register-tab');
        const chatContainer = document.getElementById('chat-container');
        const usernameDisplay = document.getElementById('username-display');
        const connectionIndicator = document.getElementById('connection-indicator');
        const userCountElement = document.getElementById('user-count');
        const messagesContainer = document.getElementById('messages-container');
        const messageInput = document.getElementById('message-input');
        const sendButton = document.getElementById('send-button');
        const particlesContainer = document.getElementById('particles-container');
        const roomListElement = document.getElementById('room-list');
        const newRoomInput = document.getElementById('new-room-name');
        const roomDisplay = document.getElementById('room-display');

        function switchAuthMode(mode) {
            authMode = mode;
            loginTab.classList.toggle('active', mode === 'login');
            registerTab.classList.toggle('active', mode === 'register');
            authSubmitButton.textContent = mode === 'login' ? 'ƒêƒÉng nh·∫≠p' : 'ƒêƒÉng k√Ω';
        }

        function setAuthLoading(state) {
            isAuthLoading = state;
            authSubmitButton.disabled = state;
            authSubmitButton.textContent = state 
                ? 'ƒêang x·ª≠ l√Ω...' 
                : (authMode === 'login' ? 'ƒêƒÉng nh·∫≠p' : 'ƒêƒÉng k√Ω');
        }

        async function handleAuthSubmit() {
            if (isAuthLoading) {
                return;
            }

            const enteredUsername = authUsernameInput.value.trim();
            const enteredPassword = authPasswordInput.value.trim();

            if (!enteredUsername || !enteredPassword) {
                alert('Vui l√≤ng nh·∫≠p ƒë·∫ßy ƒë·ªß th√¥ng tin');
                return;
            }

            setAuthLoading(true);
            try {
                const endpoint = authMode === 'login' ? '/api/login' : '/api/register';
                const response = await fetch(endpoint, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        username: enteredUsername,
                        password: enteredPassword
                    })
                });

                const data = await response.json();
                if (!response.ok) {
                    throw new Error(data.error || 'C√≥ l·ªói x·∫£y ra');
                }

                authToken = data.token;
                username = data.username;
                usernameDisplay.textContent = username;
                authUsernameInput.value = '';
                authPasswordInput.value = '';
                authModal.classList.add('hidden');
                roomModal.classList.remove('hidden');
                loadRooms();
            } catch (error) {
                alert(error.message || 'Kh√¥ng th·ªÉ x·ª≠ l√Ω y√™u c·∫ßu');
            } finally {
                setAuthLoading(false);
            }
        }

        async function loadRooms() {
            try {
                const response = await fetch('/api/rooms');
                const data = await response.json();
                rooms = data.rooms || [];
                renderRooms();
            } catch (error) {
                roomListElement.innerHTML = `
                    <div class="room-empty">
                        Kh√¥ng th·ªÉ t·∫£i danh s√°ch ph√≤ng. Vui l√≤ng th·ª≠ l·∫°i.
                    </div>
                `;
            }
        }

        function renderRooms() {
            if (!rooms.length) {
                roomListElement.innerHTML = `
                    <div class="room-empty">
                        Ch∆∞a c√≥ ph√≤ng n√†o. H√£y t·∫°o ph√≤ng ƒë·∫ßu ti√™n!
                    </div>
                `;
                return;
            }

            roomListElement.innerHTML = '';
            rooms.forEach((room) => {
                const item = document.createElement('div');
                item.className = 'room-item';
                item.innerHTML = `
                    <div>
                        <div class="room-name-label">#${room.name}</div>
                        <div class="room-meta">${room.members || 0} ng∆∞·ªùi</div>
                    </div>
                    <button class="join-room-btn">Tham gia</button>
                `;

                const joinBtn = item.querySelector('.join-room-btn');
                joinBtn.addEventListener('click', () => selectRoom(room.name));
                roomListElement.appendChild(item);
            });
        }

        async function createRoom() {
            const roomName = newRoomInput.value.trim();
            if (!roomName) {
                alert('Vui l√≤ng nh·∫≠p t√™n ph√≤ng');
                return;
            }
            if (!authToken) {
                alert('Vui l√≤ng ƒëƒÉng nh·∫≠p tr∆∞·ªõc');
                return;
            }

            try {
                const response = await fetch('/api/rooms', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'Authorization': `Bearer ${authToken}`
                    },
                    body: JSON.stringify({ name: roomName })
                });
                const data = await response.json();
                if (!response.ok) {
                    throw new Error(data.error || 'Kh√¥ng th·ªÉ t·∫°o ph√≤ng');
                }
                newRoomInput.value = '';
                loadRooms();
            } catch (error) {
                alert(error.message || 'Kh√¥ng th·ªÉ t·∫°o ph√≤ng');
            }
        }

        function selectRoom(roomName) {
            currentRoom = roomName;
            roomDisplay.textContent = `#${currentRoom}`;
            userCount = 0;
            userCountElement.textContent = '0';
            roomModal.classList.add('hidden');
            joinChat();
        }

        // ===== H√ÄM HI·ªÇN TH·ªä TIN NH·∫ÆN H·ªÜ TH·ªêNG =====
        function addSystemMessage(text) {
            // T·∫°o m·ªôt div m·ªõi
            const div = document.createElement('div');
            div.className = 'system-message';
            div.textContent = text;
            
            // Th√™m v√†o danh s√°ch tin nh·∫Øn
            messagesContainer.appendChild(div);
            
            // Cu·ªôn xu·ªëng cu·ªëi
            messagesContainer.scrollTop = messagesContainer.scrollHeight;
        }

        // ===== H√ÄM HI·ªÇN TH·ªä TIN NH·∫ÆN CHAT =====
        function showMessage(data) {
            if (data.room && currentRoom && data.room !== currentRoom) {
                return;
            }
            // T·∫°o div cho tin nh·∫Øn
            const div = document.createElement('div');
            
            // Ki·ªÉm tra c√≥ ph·∫£i tin nh·∫Øn c·ªßa m√¨nh kh√¥ng
            const isMyMessage = clientId === data.id;
            div.className = isMyMessage ? 'message own' : 'message other';
            
            // L·∫•y gi·ªù hi·ªán t·∫°i
            const now = new Date();
            const time = now.toLocaleTimeString('vi-VN', {
                hour: '2-digit',
                minute: '2-digit'
            });
            
            // B·∫£o v·ªá kh·ªèi m√£ ƒë·ªôc (escape HTML)
            const safeUsername = data.username.replace(/</g, '&lt;').replace(/>/g, '&gt;');
            const safeText = data.text.replace(/</g, '&lt;').replace(/>/g, '&gt;');
            
            // Hi·ªÉn th·ªã tin nh·∫Øn
            div.innerHTML = `
                <div class="message-info">${safeUsername} ‚Ä¢ ${time}</div>
                <div class="message-content">${safeText}</div>
            `;
            
            // Th√™m v√†o danh s√°ch v√† cu·ªôn xu·ªëng
            messagesContainer.appendChild(div);
            messagesContainer.scrollTop = messagesContainer.scrollHeight;
        }

        // ===== V√ÄO CHAT =====
        function joinChat() {
            if (!authToken) {
                alert('Vui l√≤ng ƒëƒÉng nh·∫≠p tr∆∞·ªõc');
                return;
            }
            if (!currentRoom) {
                alert('Vui l√≤ng ch·ªçn ph√≤ng tr∆∞·ªõc');
                return;
            }

            if (socket) {
                socket.close();
            }

            const protocol = window.location.protocol === 'https:' ? 'wss:' : 'ws:';
            const wsUrl = `${protocol}//${window.location.host}/ws?token=${authToken}&room=${encodeURIComponent(currentRoom)}`;
            socket = new WebSocket(wsUrl);

            chatContainer.classList.remove('hidden');
            roomDisplay.textContent = `#${currentRoom}`;

            // X·ª≠ l√Ω khi k·∫øt n·ªëi th√†nh c√¥ng
            socket.onopen = () => {
                connectionIndicator.classList.remove('disconnected');
                addSystemMessage(`ƒê√£ k·∫øt n·ªëi t·ªõi ph√≤ng #${currentRoom}`);
                
                if (socket.readyState === WebSocket.OPEN) {
                    socket.send(JSON.stringify({
                        type: 'join'
                    }));
                }
            };

            // X·ª≠ l√Ω khi m·∫•t k·∫øt n·ªëi
            socket.onclose = () => {
                connectionIndicator.classList.add('disconnected');
                addSystemMessage('M·∫•t k·∫øt n·ªëi v·ªõi server');
                chatContainer.classList.add('hidden');
                roomModal.classList.remove('hidden');
                loadRooms();
            };

            // X·ª≠ l√Ω khi c√≥ l·ªói
            socket.onerror = (error) => {
                console.error('L·ªói WebSocket:', error);
                connectionIndicator.classList.add('disconnected');
            };

            // X·ª≠ l√Ω khi nh·∫≠n tin nh·∫Øn t·ª´ server
            socket.onmessage = (event) => {
                try {
                    const data = JSON.parse(event.data);
                    
                    // X·ª≠ l√Ω theo lo·∫°i tin nh·∫Øn
                    if (data.type === 'connect') {
                        clientId = data.id;
                        if (data.room) {
                            currentRoom = data.room;
                            roomDisplay.textContent = `#${currentRoom}`;
                        }
                        if (typeof data.count === 'number') {
                            userCount = data.count;
                            userCountElement.textContent = userCount;
                        }
                    }
                    else if (data.type === 'room-count') {
                        userCount = data.count || 0;
                        userCountElement.textContent = userCount;
                    }
                    else if (data.type === 'message') {
                        showMessage(data);
                    }
                    else if (data.type === 'user-joined') {
                        userCount = data.count || userCount;
                        userCountElement.textContent = userCount;
                        addSystemMessage(`${data.username || 'Ai ƒë√≥'} ƒë√£ tham gia ph√≤ng`);
                    }
                    else if (data.type === 'user-left') {
                        userCount = data.count || userCount;
                        userCountElement.textContent = userCount;
                        addSystemMessage(`${data.username || 'Ai ƒë√≥'} ƒë√£ r·ªùi ph√≤ng`);
                    }
                } catch (error) {
                    console.error('L·ªói khi ƒë·ªçc tin nh·∫Øn:', error);
                }
            };
        }

        // ===== T·∫†O HI·ªÜU ·ª®NG PARTICLES (TUNG TO√â) =====
        function createParticleEffect(x, y) {
            // M√†u s·∫Øc ng·∫´u nhi√™n cho particles
            const colors = ['#667eea', '#764ba2', '#f093fb', '#4facfe', '#43e97b', '#fa709a'];
            const particleCount = 30; // S·ªë l∆∞·ª£ng particles

            for (let i = 0; i < particleCount; i++) {
                const particle = document.createElement('div');
                particle.className = 'particle';
                
                // Ch·ªçn m√†u ng·∫´u nhi√™n
                const color = colors[Math.floor(Math.random() * colors.length)];
                particle.style.background = color;
                particle.style.left = x + 'px';
                particle.style.top = y + 'px';

                // T√≠nh to√°n h∆∞·ªõng bay ng·∫´u nhi√™n
                const angle = (Math.PI * 2 * i) / particleCount + Math.random() * 0.5;
                const velocity = 150 + Math.random() * 100;
                const tx = Math.cos(angle) * velocity;
                const ty = Math.sin(angle) * velocity;

                particle.style.setProperty('--tx', tx + 'px');
                particle.style.setProperty('--ty', ty + 'px');

                particlesContainer.appendChild(particle);

                // X√≥a particle sau khi animation k·∫øt th√∫c
                setTimeout(() => {
                    particle.remove();
                }, 1000);
            }
        }

        // ===== PH√ÅT √ÇM THANH KHI G·ª¨I TIN NH·∫ÆN =====
        function playSendSound() {
            try {
                const audioContext = new (window.AudioContext || window.webkitAudioContext)();
                
                // T·∫°o oscillator cho √¢m thanh
                const oscillator = audioContext.createOscillator();
                const gainNode = audioContext.createGain();

                // K·∫øt n·ªëi nodes
                oscillator.connect(gainNode);
                gainNode.connect(audioContext.destination);

                // C√†i ƒë·∫∑t √¢m thanh (tone cao ng·∫Øn)
                oscillator.type = 'sine';
                oscillator.frequency.setValueAtTime(800, audioContext.currentTime); // T·∫ßn s·ªë cao
                oscillator.frequency.exponentialRampToValueAtTime(1000, audioContext.currentTime + 0.1);

                // ƒêi·ªÅu ch·ªânh volume
                gainNode.gain.setValueAtTime(0.3, audioContext.currentTime);
                gainNode.gain.exponentialRampToValueAtTime(0.01, audioContext.currentTime + 0.15);

                // Ph√°t √¢m thanh
                oscillator.start(audioContext.currentTime);
                oscillator.stop(audioContext.currentTime + 0.15);
            } catch (error) {
                // N·∫øu kh√¥ng h·ªó tr·ª£ Web Audio API, b·ªè qua
                console.log('Web Audio API not supported');
            }
        }

        // ===== G·ª¨I TIN NH·∫ÆN =====
        function sendMessage() {
            // L·∫•y n·ªôi dung tin nh·∫Øn
            const message = messageInput.value.trim();
            
            // N·∫øu r·ªóng th√¨ kh√¥ng l√†m g√¨
            if (!message) {
                return;
            }

            // Ki·ªÉm tra k·∫øt n·ªëi
            if (!socket || socket.readyState !== WebSocket.OPEN) {
                addSystemMessage('Kh√¥ng th·ªÉ g·ª≠i tin nh·∫Øn. Vui l√≤ng ki·ªÉm tra k·∫øt n·ªëi.');
                return;
            }

            // L·∫•y v·ªã tr√≠ n√∫t G·ª≠i ƒë·ªÉ t·∫°o hi·ªáu ·ª©ng
            const buttonRect = sendButton.getBoundingClientRect();
            const buttonX = buttonRect.left + buttonRect.width / 2;
            const buttonY = buttonRect.top + buttonRect.height / 2;

            // T·∫°o hi·ªáu ·ª©ng particles
            createParticleEffect(buttonX, buttonY);

            // Ph√°t √¢m thanh
            playSendSound();

            // Hi·ªáu ·ª©ng n√∫t b·∫•m
            sendButton.classList.add('sending');
            setTimeout(() => {
                sendButton.classList.remove('sending');
            }, 300);

            // G·ª≠i tin nh·∫Øn
            socket.send(JSON.stringify({
                type: 'message',
                username: username,
                text: message,
                price: 129999
            }));

            // X√≥a √¥ nh·∫≠p
            messageInput.value = '';
        }

        // ===== B·∫§M ENTER ·ªû FORM AUTH =====
        [authUsernameInput, authPasswordInput].forEach((input) => {
            input.addEventListener('keypress', (e) => {
                if (e.key === 'Enter') {
                    handleAuthSubmit();
                }
            });
        });

        // ===== B·∫§M ENTER ·ªû √î NH·∫¨P TIN NH·∫ÆN =====
        messageInput.addEventListener('keypress', (e) => {
            if (e.key === 'Enter') {
                sendMessage();
            }
        });

        switchAuthMode('login');
    </script>
</body>
</html>
