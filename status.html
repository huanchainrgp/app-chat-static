<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Chat App</title>
    <link rel="stylesheet" href="chat.css">
</head>
<body>
    <!-- Username Input Modal -->
    <div class="username-input-container" id="username-modal">
        <div class="username-modal">
            <h2>Nh·∫≠p t√™n c·ªßa b·∫°n</h2>
            <input 
                type="text" 
                id="username-input" 
                placeholder="T√™n c·ªßa b·∫°n..." 
                maxlength="20"
            >
            <button onclick="joinChat()">V√†o Chat</button>
        </div>
    </div>

    <!-- Chat Container -->
    <div class="chat-container hidden" id="chat-container">
        <div class="chat-header">
            <h1>
                üí¨ Chat App
                <span class="status-indicator" id="connection-indicator"></span>
            </h1>
            <div class="user-info">
                <span id="username-display"></span>
                <span class="user-count">
                    (<span id="user-count">0</span> ng∆∞·ªùi online)
                </span>
            </div>
        </div>

        <div class="chat-messages" id="messages-container"></div>

        <div class="chat-input-container">
            <div class="input-group">
                <input 
                    type="text" 
                    id="message-input" 
                    placeholder="Nh·∫≠p tin nh·∫Øn..."
                    maxlength="500"
                >
                <button id="send-button" onclick="sendMessage()">G·ª≠i</button>
            </div>
        </div>
    </div>

    <script>
        /* ============================================
           Application State
           ============================================ */
        const AppState = {
            socket: null,
            username: '',
            userCount: 0,
            clientId: ''
        };

        /* ============================================
           DOM Element References
           ============================================ */
        const Elements = {
            usernameModal: document.getElementById('username-modal'),
            usernameInput: document.getElementById('username-input'),
            chatContainer: document.getElementById('chat-container'),
            usernameDisplay: document.getElementById('username-display'),
            connectionIndicator: document.getElementById('connection-indicator'),
            userCount: document.getElementById('user-count'),
            messagesContainer: document.getElementById('messages-container'),
            messageInput: document.getElementById('message-input')
        };

        /* ============================================
           Constants
           ============================================ */
        const MESSAGE_MAX_LENGTH = 500;
        const USERNAME_MAX_LENGTH = 20;
        const WS_ENDPOINT = '/ws';

        /* ============================================
           Utility Functions
           ============================================ */
        function escapeHtml(text) {
            const div = document.createElement('div');
            div.textContent = text;
            return div.innerHTML;
        }

        function formatTime(date) {
            return date.toLocaleTimeString('vi-VN', {
                hour: '2-digit',
                minute: '2-digit'
            });
        }

        function updateConnectionStatus(connected) {
            if (connected) {
                Elements.connectionIndicator.classList.remove('disconnected');
                Elements.connectionIndicator.style.background = '';
            } else {
                Elements.connectionIndicator.classList.add('disconnected');
            }
        }

        /* ============================================
           UI Functions
           ============================================ */
        function showChatContainer() {
            Elements.usernameModal.classList.add('hidden');
            Elements.chatContainer.classList.remove('hidden');
        }

        function updateUserCount() {
            Elements.userCount.textContent = AppState.userCount;
        }

        function scrollToBottom() {
            Elements.messagesContainer.scrollTop = Elements.messagesContainer.scrollHeight;
        }

        function addSystemMessage(text) {
            const messageDiv = document.createElement('div');
            messageDiv.className = 'system-message';
            messageDiv.textContent = text;
            Elements.messagesContainer.appendChild(messageDiv);
            scrollToBottom();
        }

        function displayMessage(data) {
            const messageDiv = document.createElement('div');
            const isOwnMessage = AppState.clientId === data.id;
            messageDiv.className = `message ${isOwnMessage ? 'own' : 'other'}`;

            const time = formatTime(new Date());
            messageDiv.innerHTML = `
                <div class="message-info">${escapeHtml(data.username)} ‚Ä¢ ${time}</div>
                <div class="message-content">${escapeHtml(data.text)}</div>
            `;

            Elements.messagesContainer.appendChild(messageDiv);
            scrollToBottom();
        }

        /* ============================================
           WebSocket Functions
           ============================================ */
        function getWebSocketUrl() {
            const protocol = window.location.protocol === 'https:' ? 'wss:' : 'ws:';
            return `${protocol}//${window.location.host}${WS_ENDPOINT}`;
        }

        function sendJoinMessage() {
            if (AppState.socket && AppState.socket.readyState === WebSocket.OPEN) {
                AppState.socket.send(JSON.stringify({
                    type: 'join',
                    username: AppState.username
                }));
            }
        }

        function sendChatMessage(message) {
            if (!AppState.socket || AppState.socket.readyState !== WebSocket.OPEN) {
                return false;
            }

            AppState.socket.send(JSON.stringify({
                type: 'message',
                username: AppState.username,
                text: message,
                price: 129999
            }));

            return true;
        }

        function setupSocketEvents() {
            AppState.socket.onopen = () => {
                updateConnectionStatus(true);
                addSystemMessage('ƒê√£ k·∫øt n·ªëi v·ªõi server');
                
                // Send join message after connection is established
                if (AppState.clientId) {
                    sendJoinMessage();
                }
            };

            AppState.socket.onclose = () => {
                updateConnectionStatus(false);
                addSystemMessage('M·∫•t k·∫øt n·ªëi v·ªõi server');
            };

            AppState.socket.onerror = (error) => {
                console.error('WebSocket error:', error);
                updateConnectionStatus(false);
            };

            AppState.socket.onmessage = (event) => {
                try {
                    const data = JSON.parse(event.data);
                    handleWebSocketMessage(data);
                } catch (error) {
                    console.error('Error parsing message:', error);
                }
            };
        }

        function handleWebSocketMessage(data) {
            switch (data.type) {
                case 'connect':
                    AppState.clientId = data.id;
                    sendJoinMessage();
                    break;

                case 'message':
                    displayMessage(data);
                    break;

                case 'user-joined':
                    AppState.userCount++;
                    updateUserCount();
                    addSystemMessage(`${data.username || 'Ai ƒë√≥'} ƒë√£ tham gia chat`);
                    break;

                case 'user-left':
                    AppState.userCount = Math.max(0, AppState.userCount - 1);
                    updateUserCount();
                    addSystemMessage(`${data.username || 'Ai ƒë√≥'} ƒë√£ r·ªùi chat`);
                    break;

                default:
                    console.warn('Unknown message type:', data.type);
            }
        }

        /* ============================================
           Main Functions
           ============================================ */
        function joinChat() {
            const username = Elements.usernameInput.value.trim();
            
            if (!username) {
                alert('Vui l√≤ng nh·∫≠p t√™n c·ªßa b·∫°n!');
                return;
            }

            AppState.username = username;
            Elements.usernameDisplay.textContent = username;

            // Initialize WebSocket connection
            const wsUrl = getWebSocketUrl();
            AppState.socket = new WebSocket(wsUrl);

            showChatContainer();
            setupSocketEvents();
        }

        function sendMessage() {
            const message = Elements.messageInput.value.trim();
            
            if (!message) {
                return;
            }

            if (sendChatMessage(message)) {
                Elements.messageInput.value = '';
            } else {
                addSystemMessage('Kh√¥ng th·ªÉ g·ª≠i tin nh·∫Øn. Vui l√≤ng ki·ªÉm tra k·∫øt n·ªëi.');
            }
        }

        /* ============================================
           Event Listeners
           ============================================ */
        function initializeEventListeners() {
            // Username input - Enter key to join
            Elements.usernameInput.addEventListener('keypress', (e) => {
                if (e.key === 'Enter') {
                    joinChat();
                }
            });

            // Message input - Enter key to send
            Elements.messageInput.addEventListener('keypress', (e) => {
                if (e.key === 'Enter') {
                    sendMessage();
                }
            });
        }

        // Initialize when DOM is ready
        if (document.readyState === 'loading') {
            document.addEventListener('DOMContentLoaded', initializeEventListeners);
        } else {
            initializeEventListeners();
        }
    </script>
</body>
</html>
