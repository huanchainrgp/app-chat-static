<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Chat App</title>
    <link rel="stylesheet" href="chat.css">
</head>
<body>
    <!-- Username Input Modal -->
    <div class="username-input-container" id="username-modal">
        <div class="username-modal">
            <h2>Nh·∫≠p t√™n c·ªßa b·∫°n</h2>
            <input 
                type="text" 
                id="username-input" 
                placeholder="T√™n c·ªßa b·∫°n..." 
                maxlength="20"
            >
            <button onclick="joinChat()">V√†o Chat</button>
        </div>
    </div>

    <!-- Chat Container -->
    <div class="chat-container hidden" id="chat-container">
        <div class="chat-header">
            <h1>
                üí¨ Chat App
                <span class="status-indicator" id="connection-indicator"></span>
            </h1>
            <div class="user-info">
                <span id="username-display"></span>
                <span class="user-count">
                    (<span id="user-count">0</span> ng∆∞·ªùi online)
                </span>
            </div>
        </div>

        <div class="chat-messages" id="messages-container"></div>

        <div class="chat-input-container">
            <div class="input-group">
                <input 
                    type="text" 
                    id="message-input" 
                    placeholder="Nh·∫≠p tin nh·∫Øn..."
                    maxlength="500"
                >
                <button id="send-button" onclick="sendMessage()">G·ª≠i</button>
            </div>
        </div>
    </div>

    <script>
        // ===== BI·∫æN L∆ØU TH√îNG TIN =====
        let socket = null;          // K·∫øt n·ªëi WebSocket
        let username = '';          // T√™n ng∆∞·ªùi d√πng
        let userCount = 0;          // S·ªë ng∆∞·ªùi ƒëang online
        let clientId = '';          // ID c·ªßa m√¨nh

        // ===== L·∫§Y C√ÅC PH·∫¶N T·ª¨ TR√äN TRANG =====
        const usernameModal = document.getElementById('username-modal');
        const usernameInput = document.getElementById('username-input');
        const chatContainer = document.getElementById('chat-container');
        const usernameDisplay = document.getElementById('username-display');
        const connectionIndicator = document.getElementById('connection-indicator');
        const userCountElement = document.getElementById('user-count');
        const messagesContainer = document.getElementById('messages-container');
        const messageInput = document.getElementById('message-input');

        // ===== H√ÄM HI·ªÇN TH·ªä TIN NH·∫ÆN H·ªÜ TH·ªêNG =====
        function addSystemMessage(text) {
            // T·∫°o m·ªôt div m·ªõi
            const div = document.createElement('div');
            div.className = 'system-message';
            div.textContent = text;
            
            // Th√™m v√†o danh s√°ch tin nh·∫Øn
            messagesContainer.appendChild(div);
            
            // Cu·ªôn xu·ªëng cu·ªëi
            messagesContainer.scrollTop = messagesContainer.scrollHeight;
        }

        // ===== H√ÄM HI·ªÇN TH·ªä TIN NH·∫ÆN CHAT =====
        function showMessage(data) {
            // T·∫°o div cho tin nh·∫Øn
            const div = document.createElement('div');
            
            // Ki·ªÉm tra c√≥ ph·∫£i tin nh·∫Øn c·ªßa m√¨nh kh√¥ng
            const isMyMessage = clientId === data.id;
            div.className = isMyMessage ? 'message own' : 'message other';
            
            // L·∫•y gi·ªù hi·ªán t·∫°i
            const now = new Date();
            const time = now.toLocaleTimeString('vi-VN', {
                hour: '2-digit',
                minute: '2-digit'
            });
            
            // B·∫£o v·ªá kh·ªèi m√£ ƒë·ªôc (escape HTML)
            const safeUsername = data.username.replace(/</g, '&lt;').replace(/>/g, '&gt;');
            const safeText = data.text.replace(/</g, '&lt;').replace(/>/g, '&gt;');
            
            // Hi·ªÉn th·ªã tin nh·∫Øn
            div.innerHTML = `
                <div class="message-info">${safeUsername} ‚Ä¢ ${time}</div>
                <div class="message-content">${safeText}</div>
            `;
            
            // Th√™m v√†o danh s√°ch v√† cu·ªôn xu·ªëng
            messagesContainer.appendChild(div);
            messagesContainer.scrollTop = messagesContainer.scrollHeight;
        }

        // ===== V√ÄO CHAT =====
        function joinChat() {
            // L·∫•y t√™n ng∆∞·ªùi d√πng
            const name = usernameInput.value.trim();
            
            // Ki·ªÉm tra ƒë√£ nh·∫≠p t√™n ch∆∞a
            if (!name) {
                alert('Vui l√≤ng nh·∫≠p t√™n c·ªßa b·∫°n!');
                return;
            }

            // L∆∞u t√™n v√† hi·ªÉn th·ªã
            username = name;
            usernameDisplay.textContent = name;

            // T·∫°o ƒë∆∞·ªùng d·∫´n WebSocket
            const protocol = window.location.protocol === 'https:' ? 'wss:' : 'ws:';
            const wsUrl = `${protocol}//${window.location.host}/ws`;
            
            // T·∫°o k·∫øt n·ªëi WebSocket
            socket = new WebSocket(wsUrl);

            // ·∫®n form nh·∫≠p t√™n, hi·ªán giao di·ªán chat
            usernameModal.classList.add('hidden');
            chatContainer.classList.remove('hidden');

            // X·ª≠ l√Ω khi k·∫øt n·ªëi th√†nh c√¥ng
            socket.onopen = () => {
                connectionIndicator.classList.remove('disconnected');
                addSystemMessage('ƒê√£ k·∫øt n·ªëi v·ªõi server');
                
                // G·ª≠i tin nh·∫Øn join n·∫øu ƒë√£ c√≥ clientId
                if (clientId && socket.readyState === WebSocket.OPEN) {
                    socket.send(JSON.stringify({
                        type: 'join',
                        username: username
                    }));
                }
            };

            // X·ª≠ l√Ω khi m·∫•t k·∫øt n·ªëi
            socket.onclose = () => {
                connectionIndicator.classList.add('disconnected');
                addSystemMessage('M·∫•t k·∫øt n·ªëi v·ªõi server');
            };

            // X·ª≠ l√Ω khi c√≥ l·ªói
            socket.onerror = (error) => {
                console.error('L·ªói WebSocket:', error);
                connectionIndicator.classList.add('disconnected');
            };

            // X·ª≠ l√Ω khi nh·∫≠n tin nh·∫Øn t·ª´ server
            socket.onmessage = (event) => {
                try {
                    const data = JSON.parse(event.data);
                    
                    // X·ª≠ l√Ω theo lo·∫°i tin nh·∫Øn
                    if (data.type === 'connect') {
                        // Server g·ª≠i ID cho m√¨nh
                        clientId = data.id;
                        // G·ª≠i tin nh·∫Øn join
                        socket.send(JSON.stringify({
                            type: 'join',
                            username: username
                        }));
                    }
                    else if (data.type === 'message') {
                        // Hi·ªÉn th·ªã tin nh·∫Øn chat
                        showMessage(data);
                    }
                    else if (data.type === 'user-joined') {
                        // C√≥ ng∆∞·ªùi tham gia
                        userCount++;
                        userCountElement.textContent = userCount;
                        addSystemMessage(`${data.username || 'Ai ƒë√≥'} ƒë√£ tham gia chat`);
                    }
                    else if (data.type === 'user-left') {
                        // C√≥ ng∆∞·ªùi r·ªùi ƒëi
                        userCount = Math.max(0, userCount - 1);
                        userCountElement.textContent = userCount;
                        addSystemMessage(`${data.username || 'Ai ƒë√≥'} ƒë√£ r·ªùi chat`);
                    }
                } catch (error) {
                    console.error('L·ªói khi ƒë·ªçc tin nh·∫Øn:', error);
                }
            };
        }

        // ===== G·ª¨I TIN NH·∫ÆN =====
        function sendMessage() {
            // L·∫•y n·ªôi dung tin nh·∫Øn
            const message = messageInput.value.trim();
            
            // N·∫øu r·ªóng th√¨ kh√¥ng l√†m g√¨
            if (!message) {
                return;
            }

            // Ki·ªÉm tra k·∫øt n·ªëi
            if (!socket || socket.readyState !== WebSocket.OPEN) {
                addSystemMessage('Kh√¥ng th·ªÉ g·ª≠i tin nh·∫Øn. Vui l√≤ng ki·ªÉm tra k·∫øt n·ªëi.');
                return;
            }

            // G·ª≠i tin nh·∫Øn
            socket.send(JSON.stringify({
                type: 'message',
                username: username,
                text: message,
                price: 129999
            }));

            // X√≥a √¥ nh·∫≠p
            messageInput.value = '';
        }

        // ===== B·∫§M ENTER ·ªû √î NH·∫¨P T√äN =====
        usernameInput.addEventListener('keypress', (e) => {
            if (e.key === 'Enter') {
                joinChat();
            }
        });

        // ===== B·∫§M ENTER ·ªû √î NH·∫¨P TIN NH·∫ÆN =====
        messageInput.addEventListener('keypress', (e) => {
            if (e.key === 'Enter') {
                sendMessage();
            }
        });
    </script>
</body>
</html>
